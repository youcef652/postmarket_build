name: Build postmarketOS Image

on:
  workflow_dispatch: # يتيح التشغيل اليدوي من واجهة GitHub

jobs:
  build:
    # يعمل على بيئة Ubuntu المضيفة لتجنب مشاكل شبكة Docker الداخلية
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Ubuntu Dependencies and Clone pmbootstrap
        run: |
          # تثبيت متطلبات Ubuntu الأساسية فقط
          sudo apt update
          sudo apt install -y python3 python3-pip git openssl qemu-user-static wget curl
          
          # استنساخ pmbootstrap من GitLab الرسمي
          git clone gitlab.postmarketos.org

      - name: Setup pmbootstrap Configuration and Build
        run: |
          cd pmbootstrap
          # تهيئة الإعدادات للجهاز المحدد (samsung-j3xnlte) والواجهة (sxmo)
          ./pmbootstrap.py init \
            --work /home/runner/work/pmbootstrap_work \
            --arch armv7 \
            --device samsung-j3xnlte \
            --ui sxmo \
            --version edge
          
          # ضبط عناوين المرايا بشكل صريح لتجنب الغموض
          ./pmbootstrap.py config mirrors.alpine dl-cdn.alpinelinux.org
          ./pmbootstrap.py config mirrors.pmaports mirror.postmarketos.org

          # بناء وتصدير النظام
          ./pmbootstrap.py install --password 147147
          ./pmbootstrap.py export

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: postmarketOS-j3xnlte-image
          # المسار الذي ستجد فيه ملفات .img الناتجة
          path: /home/runner/work/pmbootstrap_work/chroot_native/home/pmos/rootfs/
          retention-days: 7 # الاحتفاظ بالملفات لمدة 7 أيام



