name: Build postmarketOS Image

on:
  workflow_dispatch: # يتيح التشغيل اليدوي من واجهة GitHub

jobs:
  build:
    runs-on: ubuntu-latest
    
    # استخدام صورة Docker تحتوي على pmbootstrap وجميع متطلبات Alpine Linux مسبقاً
    container:
      image: registry.gitlab.postmarketos.org/postmarketos/pmbootstrap:edge
      options: --user root

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        # بما أننا داخل كونتينر، نحتاج لتحديد مسار العمل
        with:
          path: pmos-repo

      - name: Setup pmbootstrap Configuration and Build
        run: |
          cd pmos-repo
          # تهيئة الإعدادات (نحن نستخدم الأدوات المثبتة مسبقاً داخل الكاش)
          pmbootstrap init \
            --work /home/pmos/build_work \
            --arch armv7 \
            --device samsung-j3xnlte \
            --ui sxmo \
            --version edge
          
          # ضبط المرايا بشكل صريح
          pmbootstrap config mirrors.alpine dl-cdn.alpinelinux.org
          pmbootstrap config mirrors.pmaports mirror.postmarketos.org

          # بناء وتصدير النظام في أمر واحد لتسريع العملية
          pmbootstrap install --password 147147
          pmbootstrap export

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: postmarketOS-j3xnlte-image
          # المسار داخل الكاش الخاص بالكونتينر
          path: /home/pmos/build_work/chroot_native/home/pmos/rootfs/
          retention-days: 7
